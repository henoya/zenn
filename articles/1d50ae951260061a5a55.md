---
title: "Raspberry Pi Picoで自作キーボード①"
emoji: "⌨️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["keyboard","自作キーボード","RaspberryPiPico"]
published: false
---

# Raspberry Pi Pico をコントローラとして使用

## エンジニアといえばキーボード

ソフトウェアエンジニアの端くれとして、キーボードにはこだわりがあります。
しかし、キーレイアウトとかキータッチだったり、市販のキーボードでなかなか完全に納得のいくものはありません。

納得できなければ自作しかありません。

最終目標は自作キーボードの設計、実装です。

## 自作キーボードの要素

自作キーボードに必要なコンポーネントには大きく分けて以下の要素があります。
UI要素、ハードウェアの要素とソフトウェアの要素が適度に混ざって楽しいです。

### キー自体のレイアウト設計

- **UI要素**
- 自作キーボード設計の一番のキモでしょう。自分の好みにあった使いやすいキーレイアウトを実現するのが最終目標になります。
- 自作キーボードの流行として、左右分割型エルゴノミクスキーボードやコンパクトさを追求したレイアウトがあります。
- キー以外にも、LEDで光らせたりロータリーエンコーダを回したり、小型のディスプレイをつないで情報表示させたりとオプション要素があります。

### PCB基板

- **ハードより**
- 目標のキーレイアウトを実装するための基板設計です。
- KiCad 等のフリーソフトと基板作成のサービスを使用すると、安価に自分の設計した基板を発注できます。

### ケース・ハウジング

- **ハードより**
- 基板だけでは､ショートしたり耐久性に問題あったりするので、ケースに入れたり上下にプレートを追加したりします。
- 打ち心地や打鍵音にも影響するので工夫がされていることが多いです。

### キーボードコントローラ

- **ソフトによるハード制御**
- キーボードデバイス用のファームウェアを入れることにより、キーボードの回路を制御し、PC側とUSB接続してキーボードデバイスとして認識させます。
- 基本は小型のマイコンチップですが、USBキーボードの動作をするために USB HID として振る舞える必要があります。
- 押されたキーとPCに送るキーコードのマッピングを変更することにより、回路を変更することなくキーの配置や機能を変更できます。
- 現在の自作キーボードには、ほとんどの場合 Pro Micro という Arduino 互換の小型のマイコンボードが採用されています。

### ファームウェア

- **ソフトより**
- QKM という自作キーボード用のファームウェアにキーレイアウト等を追加して Pro Micro にインストールするのが一般的です。

## 自作キーボードを作るには

これはテーマとしては広すぎます。
上記の要素を組み合わせたキットを購入して、必要な箇所を手作業するのが入り口となり、カスタマイズしたり自作したりという流れになると思います。
ハンダ付けがいらない

# Raspberry Pi Pico をコントローラとして動かしてみる

今回は完全自作までの最初のステップとして、キーボードコントローラRaspberry Pi Pico をつかってみます。
自作キーボードといえば、主流は Pro Micro ですが、今回はあえて新発の Raspberry Pi Pico をつかってみます。

## なぜ Raspberry Pi Pico なのか

Raspberry Pi Pico は Pro Micro よりひとまわり以上大きく、ピン互換もファームウェア互換も今のところありません。ではなぜあえて Raspberry Pi Pico をつかったかというと、

- 次の目標の既存キーボードの改造(キーマトリックスのハードだけつかって、コントローラを外付けする)のために入出力ピンの多い方がいい。
  - Pro Micro では入出力ピン数は最大 18 本までなのですが、改造対象のキーボードのマトリックスを調査してみたら 28 本(8 Row x 20 Col)必要ということがわかりました。
  - Raspberry Pi Pico では最大 26 本使えます。これでも 28 本には足りませんが、幸いなことに目的のキーボードは 8x20 の組み合わせ 160 キーを最大限には使用していなくて、Col の 20 本のうち接続されているキー配置がバッティングしない何本かはひとまとめにすることにより 13 本までまとめることができそうです。
  - あまったピンには LED やディスプレイなどを付けられそうです。
- 最近出た Raspberry Pi Pico をさわってみたかった
  
などの理由があります。

## Raspberry Pi Pico 向けのファームウェア

現在の所 Raspberry Pi Pico 向けにはまだ QMK ファームウェアはポートされていません(絶賛作業中とのことなので、動くようになるのは早いかも)
Raspberry Pi Pico 向けのソフトウェアを書くには C/C++ SDK もしくは MicroPython が公式にサポートされています。どちらかをつかってゴリゴリ書いてもいいのですが、幸いにも CirsuitPython という MicroPython 派生環境で動く KMK というキーボードファームウェアが使えそうなので、ひとまずはこちらを使用してみます。
CircuitPython は Python の文法で記述できて、プログラム転送も Raspberry Pi Pico をマウントした疑似FSにファイルコピーもしくはファイル直接書き換えでできるので簡単です。

## CircuitPython のインストール

### Raspberry Pi Pico向けの CircuitPython をインストール

CircuitPython のサイトから Raspberry Pi Pico 向けのファームウェアをダウンロードしてコピーします。

- ボード上の `BOOTSEL` スイッチを押しながら USBに接続
- "RPI-RP2" としてマウントされるので、ダウンロードした `.uf2` ファイルをコピーする
- アンマウントされ、`CIRCUITPY` として再マウントされる。

以後は、マウントされた `CIRCUITPY` に `.py` ファイルなどをコピーすることによってプログラムを書き換えることができます。

`CIRCUITPY/lib` に必要なライブラリをコピーします。ひとまずは以下のファイル/フォルダを入れておけばいいようです。
- `adafruit_bmp280.mpy`
- `adafruit_bus_device` フォルダ

これで CircuitPython プログラムを書くだけなら VS Code で `CIRCUITPY` ドライブの内容を直接書き換えることでプログラムの書き換えができます。
ただ、Raspberry Pi Pico からのログがみえないので、別途ログ確認の方法が必要です。

### Thonny をインストール

Raspberry Pi Pico 上の CircuitPython 操作環境として Thonny というアプリがあるので、インストールします。

## まずはLチカ

Raspberry Pi Pico にはオンボードで LED が1つ接続されているので、何も追加しなくても Lチカ はできます。
オンボードの LED は GPIO25 に接続されているので、このピンへの出力を変更すればLEDの点灯を制御できます。

`code.py` というファイル名で `CIRCUITPY` に書き込みます。

```python:code.py
import board
import digitalio
import time

led = digitalio.DigitalInOut(board.GP25)
led.direction = digitalio.Direction.OUTPUT

wait = 0.5

while True:
    led.value = True
    time.sleep(wait)
    led.value = False
    time.sleep(wait)
```

## KMK のインストール

